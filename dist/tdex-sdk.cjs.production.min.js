"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("ldk"),t=require("liquidjs-lib"),r=require("tdex-protobuf/generated/js/swap_pb"),n=require("@grpc/grpc-js"),o=require("tdex-protobuf/generated/js/trade_grpc_pb"),s=require("tdex-protobuf/generated/js/trade_pb"),i=require("tdex-protobuf/generated/js/types_pb");function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var u=function(e){this.verbose=!1,this.chain="regtest",Object.assign(this,e)};function c(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=r.length,o=0;o<e;o++)t+=r.charAt(Math.floor(Math.random()*n));return t}function p(e){var r;try{r=t.Psbt.fromBase64(e)}catch(e){throw new Error("Invalid psbt")}var n=r.data.globalMap.unsignedTx.toBuffer();return{psbt:r,transaction:t.Transaction.fromBuffer(n)}}var l=function(r,n,o){void 0===o&&(o={});try{var s=Buffer.from(n,"hex").reverse(),i=r.filter((function(e){return null!=e.witnessUtxo}));return Promise.resolve(Promise.all(i.map((function(t){try{var r=function(){if(t.witnessUtxo&&e.isConfidentialOutput(t.witnessUtxo)){var r=o[t.witnessUtxo.script.toString("hex")];if(void 0===r)throw new Error("no blindKey for script: "+t.witnessUtxo.script.toString("hex"));return Promise.resolve(e.unblindOutput({blindedAsset:t.witnessUtxo.asset,blindedValue:t.witnessUtxo.value,script:t.witnessUtxo.script.toString("hex"),surjectionProof:t.witnessUtxo.surjectionProof,rangeProof:t.witnessUtxo.rangeProof,nonce:t.witnessUtxo.nonce},r.toString("hex"))).then((function(e){var r=e.value,n=e.asset;t.value=r,t.asset=n,t.witnessUtxo.value=r}))}}();return Promise.resolve(r&&r.then?r.then((function(e){return t})):t)}catch(e){return Promise.reject(e)}})))).then((function(e){return e.filter((function(e){return s.equals(e.witnessUtxo.asset.slice(1))||e.asset===n})).map((function(e){return e.witnessUtxo.value instanceof Buffer?t.confidential.confidentialValueToSatoshi(e.witnessUtxo.value):e.witnessUtxo.value})).reduce((function(e,t){return e+t}),0)}))}catch(e){return Promise.reject(e)}},f=function(r,n,o,s){void 0===s&&(s={});try{return Promise.resolve(r.some((function(r){try{var i=!1,a=function(e){if(i)return e;var s=Buffer.from(o,"hex").reverse().equals(r.asset.slice(1)),a=t.confidential.confidentialValueToSatoshi(r.value)===n;return s&&a},u=e.isConfidentialOutput(r),c=function(){if(!0===u){var t=s[r.script.toString("hex")];if(void 0===t)throw new Error("no blind key for "+r.script.toString("hex"));return function(s,a){try{var u=Promise.resolve(e.unblindOutput({blindedAsset:r.asset,blindedValue:r.value,script:r.script.toString("hex"),surjectionProof:r.surjectionProof,rangeProof:r.rangeProof,nonce:r.nonce},t.toString("hex"))).then((function(e){return i=!0,e.value===n&&e.asset===o}))}catch(e){return a()}return u&&u.then?u.then(void 0,a):u}(0,(function(){return i=!0,!1}))}}();return Promise.resolve(c&&c.then?c.then(a):a(c))}catch(e){return Promise.reject(e)}})))}catch(e){return Promise.reject(e)}},d=function(e,r){try{var n=p(e.getTransaction());return n.psbt.data.inputs.forEach((function(e,r){if(!e.witnessUtxo&&e.nonWitnessUtxo){var o=n.transaction.ins[r].index,s=t.Transaction.fromHex(e.nonWitnessUtxo).outs[o];e.witnessUtxo=s}})),Promise.resolve(l(n.psbt.data.inputs,e.getAssetP(),m(e.getInputBlindingKeyMap()))).then((function(t){if(t<e.getAmountP())throw new Error("Cumulative utxos count is not enough to cover SwapRequest.amount_p");return Promise.resolve(f(n.transaction.outs,e.getAmountR(),e.getAssetR(),m(e.getOutputBlindingKeyMap()))).then((function(t){if(!t)throw new Error("Either SwapRequest.amount_r or SwapRequest.asset_r do not match the provided psbt (amount: "+e.getAmountR()+", asset: "+e.getAssetR()+")");return function(){if(r){var t=p(r.getTransaction());if(e.getId()!==r.getRequestId())throw new Error("SwapRequest.id and SwapAccept.request_id are not the same");return Promise.resolve(l(t.psbt.data.inputs,e.getAssetR(),m(r.getInputBlindingKeyMap()))).then((function(n){if(n<e.getAmountR())throw new Error("Cumulative utxos count is not enough to cover SwapRequest.amount_r");if(!f(t.transaction.outs,e.getAmountP(),e.getAssetP(),m(r.getOutputBlindingKeyMap())))throw new Error("Either SwapRequest.amount_p or SwapRequest.asset_p do not match the provided psbt amount="+e.getAmountP()+" asset="+e.getAssetP())}))}}()}))}))}catch(e){return Promise.reject(e)}},v=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var n=t.prototype;return n.request=function(e){var t=e.amountToBeSent,n=e.assetToBeSent,o=e.amountToReceive,s=e.assetToReceive,i=e.psetBase64,a=e.inputBlindingKeys,u=e.outputBlindingKeys;try{var p=this,l=new r.SwapRequest;return l.setId(c(8)),l.setAmountP(t),l.setAssetP(n),l.setAmountR(o),l.setAssetR(s),l.setTransaction(i),a&&Object.entries(a).forEach((function(e){var t=e[0],r=e[1];l.getInputBlindingKeyMap().set(t,Uint8Array.from(r))})),u&&Object.entries(u).forEach((function(e){var t=e[0],r=e[1];l.getOutputBlindingKeyMap().set(t,Uint8Array.from(r))})),Promise.resolve(d(l)).then((function(){return p.verbose&&console.log(l.toObject()),l.serializeBinary()}))}catch(e){return Promise.reject(e)}},n.accept=function(e){var t=e.message,n=e.psetBase64,o=e.inputBlindingKeys,s=e.outputBlindingKeys;try{var i=this,a=r.SwapRequest.deserializeBinary(t),u=new r.SwapAccept;return u.setId(c(8)),u.setRequestId(a.getId()),u.setTransaction(n),o&&Object.entries(o).forEach((function(e){var t=e[0],r=e[1];u.getInputBlindingKeyMap().set(t,Uint8Array.from(r))})),s&&Object.entries(s).forEach((function(e){var t=e[0],r=e[1];u.getOutputBlindingKeyMap().set(t,Uint8Array.from(r))})),Promise.resolve(d(a,u)).then((function(){return i.verbose&&console.log(u.toObject()),u.serializeBinary()}))}catch(e){return Promise.reject(e)}},n.complete=function(e){var t=e.message,n=e.psetBase64;if(!p(n).psbt.validateSignaturesOfAllInputs())throw new Error("Signatures not valid");var o=r.SwapAccept.deserializeBinary(t),s=new r.SwapComplete;return s.setId(c(8)),s.setAcceptId(o.getId()),s.setTransaction(n),this.verbose&&console.log(o.toObject()),s.serializeBinary()},t}(u);function m(e){var t={};return e.forEach((function(e,r){var n=e instanceof Uint8Array?Buffer.from(e):Buffer.from(e,"hex");t[r]=n})),t}v.parse=function(e){var t,n=e.message,o=e.type;try{t=r[o].deserializeBinary(n)}catch(e){throw new Error("Not valid message of expected type "+o)}return JSON.stringify(t.toObject(),void 0,2)};var h,g=function(){function r(e){this.inputBlindingKeys={},this.outputBlindingKeys={},this.identity=e,this.network=e.network,this.pset=new t.Psbt({network:this.network})}return r.prototype.create=function(r,n,o,s,i,a,u,c){var p=this;void 0===c&&(c=e.greedyCoinSelector());var l=c(r,[{value:n,asset:s,address:""}],(function(e){return u})),f=l.changeOutputs;l.selectedUtxos.forEach((function(e){if(p.pset.addInput({hash:e.txid,index:e.vout,witnessUtxo:e.prevout}),!e.prevout)throw new Error("create tx: missing prevout member for input "+e.txid+":"+e.vout);var t=e.prevout.script.toString("hex");p.inputBlindingKeys[t]=Buffer.from(p.identity.getBlindingPrivateKey(t),"hex")}));var d=e.address.toOutputScript(a,this.network).toString("hex");this.pset.addOutput({script:d,value:t.confidential.satoshiToConfidentialValue(o),asset:i,nonce:Buffer.from("00","hex")}),this.outputBlindingKeys[d]=Buffer.from(this.identity.getBlindingPrivateKey(d),"hex"),f.length>0&&f.forEach((function(r){var n=e.address.toOutputScript(r.address,p.network).toString("hex");p.pset.addOutput({script:n,value:t.confidential.satoshiToConfidentialValue(r.value),asset:r.asset,nonce:Buffer.from("00","hex")}),p.outputBlindingKeys[n]=Buffer.from(p.identity.getBlindingPrivateKey(n),"hex")}))},r}();(h=exports.TradeType||(exports.TradeType={}))[h.BUY=0]="BUY",h[h.SELL=1]="SELL";var w=function(t){function n(e,r){var n;return(n=t.call(this,e)||this).validate(e),n.utxos=e.utxos,n.coinSelector=e.coinSelector,n.grpcClient=r(e.providerUrl),n}a(n,t);var o=n.prototype;return o.validate=function(e){if(!this.providerUrl)throw new Error("To be able to trade you need to select a liquidity provider via { providerUrl }");if(!this.explorerUrl)throw new Error("To be able to trade you need to select an explorer via { explorerUrl }");if(e.utxos.length<=0)throw new Error("You need at least one utxo to trade")},o.buy=function(e){var t=e.market,r=e.amount,n=e.asset,o=e.identity;try{var s=this;return Promise.resolve(s.marketOrderRequest(t,exports.TradeType.BUY,r,n,o)).then((function(e){return Promise.resolve(s.marketOrderComplete(e,o))}))}catch(e){return Promise.reject(e)}},o.sell=function(e){var t=e.market,r=e.amount,n=e.asset,o=e.identity;try{var s=this;return Promise.resolve(s.marketOrderRequest(t,exports.TradeType.SELL,r,n,o)).then((function(e){return Promise.resolve(s.marketOrderComplete(e,o))}))}catch(e){return Promise.reject(e)}},o.preview=function(t){var r=t.market,n=t.tradeType,o=t.amount,s=t.asset;try{if(!e.isValidAmount(o))throw new Error("Amount is not valid");var i=r.baseAsset,a=r.quoteAsset;return Promise.resolve(this.grpcClient.marketPrice({baseAsset:i,quoteAsset:a},n,o,s)).then((function(e){var t=e[0].amount;return n===exports.TradeType.BUY?{assetToBeSent:a,amountToBeSent:s===i?t:o,assetToReceive:i,amountToReceive:s===i?o:t}:{assetToBeSent:i,amountToBeSent:s===a?t:o,assetToReceive:a,amountToReceive:s===a?o:t}}))}catch(e){return Promise.reject(e)}},o.marketOrderRequest=function(e,t,r,n,o){try{var s=this;return Promise.resolve(s.preview({market:e,tradeType:t,amount:r,asset:n})).then((function(r){var n=r.assetToBeSent,i=r.amountToBeSent,a=r.assetToReceive,u=r.amountToReceive,c=o.getNextAddress(),p=o.getNextChangeAddress(),l=new g(o);l.create(s.utxos,i,u,n,a,c.confidentialAddress,p.confidentialAddress);var f=new v;return Promise.resolve(f.request({assetToBeSent:n,amountToBeSent:i,assetToReceive:a,amountToReceive:u,psetBase64:l.pset.toBase64(),inputBlindingKeys:l.inputBlindingKeys,outputBlindingKeys:l.outputBlindingKeys})).then((function(r){return Promise.resolve(s.grpcClient.tradePropose(e,t,r))}))}))}catch(e){return Promise.reject(e)}},o.marketOrderComplete=function(e,t){try{var n=this,o=r.SwapAccept.deserializeBinary(e).getTransaction();return Promise.resolve(t.signPset(o)).then((function(t){var r=(new v).complete({message:e,psetBase64:t});return Promise.resolve(n.grpcClient.tradeComplete(r))}))}catch(e){return Promise.reject(e)}},n}(u),y=function(){function e(e){var t=n.credentials.createInsecure();this.providerUrl=e;var r=new URL(e);this.client=new o.TradeClient(this.providerUrl,t),r.protocol.includes("https")&&(t=n.credentials.createSsl(),this.client=new o.TradeClient(r.host,t))}var t=e.prototype;return t.tradePropose=function(e,t,n){var o=this,a=e.baseAsset,u=e.quoteAsset;return new Promise((function(e,c){var p=new i.Market;p.setBaseAsset(a),p.setQuoteAsset(u);var l=new s.TradeProposeRequest;l.setMarket(p),l.setType(t),l.setSwapRequest(r.SwapRequest.deserializeBinary(n));var f,d=o.client.tradePropose(l);d.on("data",(function(e){x(e);var t=e.getSwapAccept();f=t.serializeBinary()})),d.on("end",(function(){return e(f)})),d.on("error",(function(e){return c(e)}))}))},t.tradeComplete=function(e){var t=this;return new Promise((function(n,o){var i=new s.TradeCompleteRequest;i.setSwapComplete(r.SwapComplete.deserializeBinary(e));var a,u=t.client.tradeComplete(i);u.on("data",(function(e){x(e),a=e.getTxid()})),u.on("end",(function(){return n(a)})),u.on("error",(function(e){return o(e)}))}))},t.markets=function(){var e=this;return new Promise((function(t,r){e.client.markets(new s.MarketsRequest,(function(e,n){if(e)return r(e);var o=n.getMarketsList().map((function(e){return{baseAsset:e.getMarket().getBaseAsset(),quoteAsset:e.getMarket().getQuoteAsset(),feeBasisPoint:e.getFee().getBasisPoint()}}));t(o)}))}))},t.marketPrice=function(e,t,r,n){var o=this,a=e.baseAsset,u=e.quoteAsset,c=new i.Market;c.setBaseAsset(a),c.setQuoteAsset(u);var p=new s.MarketPriceRequest;return p.setMarket(c),p.setType(t),p.setAmount(r),p.setAsset(n),new Promise((function(e,t){o.client.marketPrice(p,(function(r,n){if(r)return t(r);var o=n.getPricesList().map((function(e){return e.toObject()}));e(o)}))}))},t.balances=function(e){var t=this,r=e.baseAsset,n=e.quoteAsset,o=new i.Market;o.setBaseAsset(r),o.setQuoteAsset(n);var a=new s.BalancesRequest;return a.setMarket(o),new Promise((function(e,r){t.client.balances(a,(function(t,n){if(t)return r(t);var o=n.getBalancesList().map((function(e){return e.toObject()}));e(o)}))}))},e}();function x(e){var t=e.getSwapFail();if(t){var r="SwapFail for message id="+t.getId()+". Failure code "+t.getFailureCode()+" | reason: "+t.getFailureMessage();throw new Error(r)}}var B=function(e){function t(t){return e.call(this,t,(function(e){return new y(e)}))||this}return a(t,e),t}(w);Object.keys(e).forEach((function(t){"default"!==t&&Object.defineProperty(exports,t,{enumerable:!0,get:function(){return e[t]}})})),exports.Swap=v,exports.SwapTransaction=g,exports.Trade=B,exports.TradeCore=w,exports.TraderClient=y,exports.blindKeysMap=m,exports.throwErrorIfSwapFail=x;
//# sourceMappingURL=tdex-sdk.cjs.production.min.js.map
